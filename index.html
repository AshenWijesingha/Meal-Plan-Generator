<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meal Plan Generator - Gayathri Dissanayaka | Professional Edition</title>

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü•ó</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@500;600;700;800&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary-blue: #1877F2;
            --dark-blue: #166FE5;
            --light-blue: #E7F3FF;
            --background: #F0F2F5;
            --white: #FFFFFF;
            --text-dark: #050505;
            --text-secondary: #65676B;
            --success-green: #42B72A;
            --border: #CCD0D5;
            --error-red: #EF4444;
            --warning-orange: #F59E0B;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--background);
        }

        h1, h2, h3, h4 {
            font-family: 'Poppins', sans-serif;
        }

        .form-step {
            display: none;
        }

        .form-step.active {
            display: block !important;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .meal-template {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .meal-template:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(24, 119, 242, 0.2);
        }

        .meal-template.selected {
            border-color: var(--primary-blue);
            background: var(--light-blue);
        }

        .checkbox-custom {
            --checkbox-size: 22px;
            appearance: none;
            width: var(--checkbox-size);
            height: var(--checkbox-size);
            min-width: var(--checkbox-size);
            min-height: var(--checkbox-size);
            flex: 0 0 var(--checkbox-size);
            border: 2px solid #94A3B8;
            background: #FFFFFF;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            box-shadow: 0 1px 2px rgba(2, 6, 23, 0.08);
        }

        .checkbox-custom:checked {
            background: var(--primary-blue);
            border-color: var(--primary-blue);
        }

        .checkbox-custom:focus-visible {
            outline: 3px solid rgba(24,119,242,0.45);
            outline-offset: 2px;
        }

        .checkbox-custom:checked::after {
            content: '‚úì';
            position: absolute;
            color: white;
            font-size: 14px;
            font-weight: 700;
            top: 0px;
            left: 4px;
        }

        .error-border {
            border-color: var(--error-red) !important;
        }

        .floating-save-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
        }

        .step-scroll {
            overflow-x: auto;
            scrollbar-width: thin;
        }

        .meal-plate-canvas {
            width: min(240px, 72vw);
            height: auto;
            border: 6px solid #ffffff;
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.12);
        }

        .chart-caption {
            max-width: 280px;
        }

        textarea {
            min-height: 8.5rem;
            resize: vertical;
        }

        .meal-schedule-textarea {
            min-height: 11.5rem;
        }

        .guidance-textarea {
            min-height: 10.5rem;
        }

        .address-textarea {
            min-height: 8.5rem;
        }

        @media (max-width: 768px) {
            .floating-save-btn {
                bottom: 1rem;
                right: 1rem;
            }

            .meal-time-title {
                font-size: 0.95rem;
                line-height: 1.25rem;
            }

            .meal-schedule-textarea {
                min-height: 9.5rem;
            }

            .guidance-textarea {
                min-height: 8.75rem;
            }

            .address-textarea {
                min-height: 7.5rem;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-blue-700 text-white py-6 md:py-8 shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <div class="text-4xl md:text-6xl">ü•ó</div>
                    <div>
                        <h1 class="text-2xl md:text-4xl font-bold">Meal Plan Generator</h1>
                        <p class="text-blue-100 text-sm md:text-lg">Gayathri Dissanayaka - Dietitian & Nutritionist</p>
                        <p class="text-blue-200 text-sm mt-1">Professional Edition with Advanced Features</p>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8 max-w-7xl">

        <!-- Progress Steps -->
        <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-6">
            <div class="md:hidden">
                <div class="flex items-center justify-between text-sm text-gray-600 mb-2">
                    <span id="mobileStepText">Step 1 of 5</span>
                    <span id="progressPercent">20%</span>
                </div>
                <div class="w-full h-2 rounded-full bg-gray-200 overflow-hidden">
                    <div id="progressBar" class="h-full bg-blue-600 transition-all duration-300" style="width: 20%;"></div>
                </div>
            </div>
            <div class="hidden md:flex justify-between items-center gap-3">
                <button type="button" data-step="1" onclick="goToStep(1, true)" class="step-trigger flex-1 min-w-[120px] text-center" id="step1-trigger">
                    <div class="w-14 h-14 bg-blue-600 text-white rounded-full flex items-center justify-center mx-auto mb-2 font-bold text-lg" id="step1-icon"><i class="fas fa-user"></i></div>
                    <span class="text-sm font-semibold text-blue-600" id="step1-label">Patient Info</span>
                </button>
                <button type="button" data-step="2" onclick="goToStep(2, true)" class="step-trigger flex-1 min-w-[120px] text-center" id="step2-trigger">
                    <div class="w-14 h-14 bg-gray-300 text-white rounded-full flex items-center justify-center mx-auto mb-2 font-bold text-lg" id="step2-icon"><i class="fas fa-ruler"></i></div>
                    <span class="text-sm text-gray-500 font-medium" id="step2-label">Measurements</span>
                </button>
                <button type="button" data-step="3" onclick="goToStep(3, true)" class="step-trigger flex-1 min-w-[120px] text-center" id="step3-trigger">
                    <div class="w-14 h-14 bg-gray-300 text-white rounded-full flex items-center justify-center mx-auto mb-2 font-bold text-lg" id="step3-icon"><i class="fas fa-utensils"></i></div>
                    <span class="text-sm text-gray-500 font-medium" id="step3-label">Meal Plan</span>
                </button>
                <button type="button" data-step="4" onclick="goToStep(4, true)" class="step-trigger flex-1 min-w-[120px] text-center" id="step4-trigger">
                    <div class="w-14 h-14 bg-gray-300 text-white rounded-full flex items-center justify-center mx-auto mb-2 font-bold text-lg" id="step4-icon"><i class="fas fa-clipboard-list"></i></div>
                    <span class="text-sm text-gray-500 font-medium" id="step4-label">Guidelines</span>
                </button>
                <button type="button" data-step="5" onclick="goToStep(5, true)" class="step-trigger flex-1 min-w-[120px] text-center" id="step5-trigger">
                    <div class="w-14 h-14 bg-gray-300 text-white rounded-full flex items-center justify-center mx-auto mb-2 font-bold text-lg" id="step5-icon"><i class="fas fa-file-pdf"></i></div>
                    <span class="text-sm text-gray-500 font-medium" id="step5-label">Generate PDF</span>
                </button>
            </div>
        </div>

        <!-- Form -->
        <div class="grid grid-cols-1 xl:grid-cols-12 gap-6">
        <form id="mealPlanForm" novalidate class="xl:col-span-8">

            <!-- Step 1: Patient Information -->
            <div class="form-step active" id="step1">
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                        <i class="fas fa-user-circle text-blue-600"></i>
                        Patient Information
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Full Name <span class="text-red-500">*</span>
                            </label>
                            <input
                                type="text"
                                id="patientName"
                                autocomplete="name"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                                placeholder="Enter patient's full name"
                                required
                            >
                            <span class="text-red-500 text-sm hidden" id="nameError">Please enter a valid name</span>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Age <span class="text-red-500">*</span>
                            </label>
                            <input
                                type="number"
                                id="patientAge"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                                placeholder="Enter age"
                                min="1"
                                max="120"
                                required
                            >
                            <span class="text-red-500 text-sm hidden" id="ageError">Age must be between 1 and 120</span>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Gender <span class="text-red-500">*</span>
                            </label>
                            <select
                                id="patientGender"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                                required
                            >
                                <option value="">Select gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                                <option value="Prefer not to say">Prefer not to say</option>
                            </select>
                            <span class="text-red-500 text-sm hidden" id="genderError">Please select gender</span>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Date <span class="text-red-500">*</span>
                            </label>
                            <input
                                type="date"
                                id="planDate"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                                required
                            >
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Next Follow-up Date
                            </label>
                            <input
                                type="date"
                                id="nextFollowupDate"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                            >
                            <span class="text-xs text-gray-500 mt-1 block">Optional. Use YYYY-MM-DD format.</span>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Phone Number
                            </label>
                            <input
                                type="tel"
                                id="patientPhone"
                                autocomplete="tel"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                                placeholder="+94 XX XXX XXXX"
                            >
                            <span class="text-red-500 text-sm hidden" id="phoneError">Invalid phone number format</span>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Email Address
                            </label>
                            <input
                                type="email"
                                id="patientEmail"
                                autocomplete="email"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                                placeholder="email@example.com"
                            >
                            <span class="text-red-500 text-sm hidden" id="emailError">Invalid email format</span>
                        </div>
                    </div>

                    <div class="mt-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Address
                        </label>
                        <textarea
                            id="patientAddress"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                            rows="3"
                            placeholder="Enter full address (optional)"
                        ></textarea>
                    </div>

                    <div class="flex justify-end mt-8">
                        <button
                            type="button"
                            onclick="validateAndNext(1)"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-10 py-4 rounded-lg font-semibold flex items-center gap-2 transition shadow-lg hover:shadow-xl"
                        >
                            Next Step <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 2: Physical Measurements -->
            <div class="form-step" id="step2">
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                        <i class="fas fa-ruler-combined text-blue-600"></i>
                        Physical Measurements & Health Data
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Height (cm) <span class="text-red-500">*</span>
                            </label>
                            <input
                                type="number"
                                id="patientHeight"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                                placeholder="e.g., 172"
                                min="100"
                                max="250"
                                step="0.1"
                                required
                                oninput="calculateBMI()"
                            >
                            <span class="text-gray-500 text-xs mt-1 block">Enter in centimeters</span>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Current Weight (kg) <span class="text-red-500">*</span>
                            </label>
                            <input
                                type="number"
                                id="patientWeight"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                                placeholder="e.g., 82"
                                min="30"
                                max="300"
                                step="0.1"
                                required
                                oninput="calculateBMI()"
                            >
                            <span class="text-gray-500 text-xs mt-1 block">Enter in kilograms</span>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Target Weight (kg) <span class="text-red-500">*</span>
                            </label>
                            <input
                                type="number"
                                id="targetWeight"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                                placeholder="e.g., 73.8"
                                min="30"
                                max="300"
                                step="0.1"
                                required
                                oninput="calculateBMI()"
                            >
                            <span class="text-gray-500 text-xs mt-1 block">Your weight goal</span>
                        </div>
                    </div>

                    <!-- BMI Display Card -->
                    <div id="bmiDisplay" class="mt-6 p-8 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl border-2 border-blue-200 shadow-md" style="display: none;">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                            <div>
                                <div class="text-6xl font-bold text-blue-600 mb-2" id="bmiValue">--</div>
                                <div class="text-lg font-semibold text-gray-700">BMI</div>
                                <div class="mt-2">
                                    <span id="bmiCategoryBadge" class="px-4 py-1 rounded-full text-sm font-semibold"></span>
                                </div>
                            </div>
                            <div>
                                <div class="text-6xl font-bold text-green-600 mb-2" id="ibwValue">--</div>
                                <div class="text-lg font-semibold text-gray-700">Ideal Body Weight</div>
                                <div class="text-sm text-gray-500 mt-2">Based on height & gender</div>
                            </div>
                            <div>
                                <div class="text-6xl font-bold text-orange-600 mb-2" id="weightToLose">--</div>
                                <div class="text-lg font-semibold text-gray-700" id="weightGoalLabel">Target Weight Change</div>
                                <div class="text-sm text-gray-500 mt-2" id="timelineEstimate">--</div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between mt-8">
                        <button
                            type="button"
                            onclick="goToStep(1)"
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-10 py-4 rounded-lg font-semibold flex items-center gap-2 transition"
                        >
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <button
                            type="button"
                            onclick="validateAndNext(2)"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-10 py-4 rounded-lg font-semibold flex items-center gap-2 transition shadow-lg hover:shadow-xl"
                        >
                            Next Step <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Meal Plan Configuration -->
            <div class="form-step" id="step3">
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                        <i class="fas fa-utensils text-blue-600"></i>
                        Meal Plan Configuration
                    </h2>

                    <!-- Plan Type Selection -->
                    <div class="mb-8">
                        <label class="block text-lg font-bold text-gray-700 mb-4">
                            Plan Type <span class="text-red-500">*</span>
                        </label>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <label class="meal-template flex items-center p-6 border-2 border-gray-300 rounded-xl cursor-pointer hover:border-blue-600 transition">
                                <input type="radio" name="planType" value="general" checked class="mr-4 w-5 h-5 accent-blue-600">
                                <div>
                                    <div class="font-bold text-lg">üìã General Plan</div>
                                    <div class="text-sm text-gray-500 mt-1">Template-based options</div>
                                </div>
                            </label>
                            <label class="meal-template flex items-center p-6 border-2 border-gray-300 rounded-xl cursor-pointer hover:border-blue-600 transition">
                                <input type="radio" name="planType" value="weekly" class="mr-4 w-5 h-5 accent-blue-600">
                                <div>
                                    <div class="font-bold text-lg">üìÖ Weekly Plan</div>
                                    <div class="text-sm text-gray-500 mt-1">7-day structured plan</div>
                                </div>
                            </label>
                            <label class="meal-template flex items-center p-6 border-2 border-gray-300 rounded-xl cursor-pointer hover:border-blue-600 transition">
                                <input type="radio" name="planType" value="custom" class="mr-4 w-5 h-5 accent-blue-600">
                                <div>
                                    <div class="font-bold text-lg">‚ú® Custom Plan</div>
                                    <div class="text-sm text-gray-500 mt-1">Fully customizable</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Dietary Preferences -->
                    <div class="mb-8">
                        <label class="block text-lg font-bold text-gray-700 mb-4">
                            Dietary Preferences
                        </label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <label class="flex items-center p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition">
                                <input type="checkbox" id="prefVegetarian" class="checkbox-custom mr-3">
                                <span class="font-semibold">ü•¨ Vegetarian Options</span>
                            </label>
                            <label class="flex items-center p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition">
                                <input type="checkbox" id="prefNonVeg" class="checkbox-custom mr-3" checked>
                                <span class="font-semibold">üçó Non-Vegetarian Options</span>
                            </label>
                            <label class="flex items-center p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition">
                                <input type="checkbox" id="prefLowCarb" class="checkbox-custom mr-3">
                                <span class="font-semibold">üåæ Low Carb</span>
                            </label>
                            <label class="flex items-center p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50 transition">
                                <input type="checkbox" id="prefHighProtein" class="checkbox-custom mr-3">
                                <span class="font-semibold">üí™ High Protein</span>
                            </label>
                        </div>
                    </div>

                    <!-- Plan Configuration -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Daily Calorie Target (kcal)
                            </label>
                            <input
                                type="number"
                                id="calorieTarget"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                                placeholder="e.g., 1845"
                                min="1000"
                                max="5000"
                            >
                            <span class="text-gray-500 text-xs mt-1 block">Auto-calculated based on BMI</span>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Plan Duration (days)
                            </label>
                            <input
                                type="number"
                                id="planDuration"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                                placeholder="e.g., 7"
                                value="7"
                                min="1"
                                max="30"
                            >
                        </div>
                    </div>

                    <!-- Plate Ratio Configuration -->
                    <div class="mb-8 p-5 md:p-6 border-2 border-gray-200 rounded-xl bg-gradient-to-br from-white to-blue-50">
                        <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-3">üçΩÔ∏è Meal Plate Ratio</h3>
                        <p class="text-sm text-gray-600 mb-5">Customize plate percentages. Total must be exactly 100% before moving to next step.</p>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-center">
                            <div class="space-y-4">
                                <div>
                                    <label for="plateVegetables" class="block text-sm font-semibold text-gray-700 mb-2">Vegetables & Fruits (%)</label>
                                    <input type="number" id="plateVegetables" min="0" max="100" value="50" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition" oninput="updateMealPlateChart()">
                                </div>
                                <div>
                                    <label for="plateProtein" class="block text-sm font-semibold text-gray-700 mb-2">Protein Foods (%)</label>
                                    <input type="number" id="plateProtein" min="0" max="100" value="25" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition" oninput="updateMealPlateChart()">
                                </div>
                                <div>
                                    <label for="plateGrains" class="block text-sm font-semibold text-gray-700 mb-2">Carbohydrates (%)</label>
                                    <input type="number" id="plateGrains" min="0" max="100" value="25" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition" oninput="updateMealPlateChart()">
                                </div>
                                <div class="bg-white border rounded-lg p-3">
                                    <p class="text-sm text-gray-700">Total: <span id="plateTotal" class="font-bold text-blue-700">100%</span></p>
                                    <p id="plateTotalError" class="text-sm text-red-600 mt-1 hidden">Plate total must equal 100%.</p>
                                </div>
                            </div>

                            <div class="flex flex-col items-center gap-3">
                                <canvas id="mealPlateCanvas" width="260" height="260" class="meal-plate-canvas max-w-full bg-white rounded-full"></canvas>
                                <p class="chart-caption text-xs text-gray-500 text-center">This preview is optimized for quick review and exported at balanced size in the final PDF.</p>
                            </div>
                        </div>
                    </div>

                    <h3 class="text-2xl font-bold text-gray-800 mb-6">üìù Daily Meal Schedule</h3>

                    <!-- Meal Time Slots -->
                    <div class="space-y-4">
                        <!-- Early Morning -->
                        <div class="border-2 border-gray-300 rounded-lg overflow-hidden">
                            <button type="button" onclick="toggleSection('earlyMorningSection')" class="w-full px-6 py-4 bg-gradient-to-r from-yellow-50 to-orange-50 hover:from-yellow-100 hover:to-orange-100 text-left font-bold flex justify-between items-center transition" aria-expanded="false" aria-controls="earlyMorningSection">
                                <span class="meal-time-title text-base">üåÖ Early Morning (7:00 - 7:30 AM)</span>
                                <i class="fas fa-chevron-down transition-transform" id="earlyMorningIcon"></i>
                            </button>
                            <div id="earlyMorningSection" class="p-6 bg-white" style="display: none;">
                                <textarea
                                    id="earlyMorning"
                                    class="meal-schedule-textarea w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                                    rows="2"
                                    placeholder="e.g., Detox water 1 glass / Warm water 1 glass&#10;ABC juice 1 glass + Swiss collagen"
                                ></textarea>
                            </div>
                        </div>

                        <!-- Breakfast -->
                        <div class="border-2 border-gray-300 rounded-lg overflow-hidden">
                            <button type="button" onclick="toggleSection('breakfastSection')" class="w-full px-6 py-4 bg-gradient-to-r from-amber-50 to-yellow-50 hover:from-amber-100 hover:to-yellow-100 text-left font-bold flex justify-between items-center transition" aria-expanded="false" aria-controls="breakfastSection">
                                <span class="meal-time-title text-xl">‚òï Breakfast (8:00 - 9:00 AM)</span>
                                <i class="fas fa-chevron-down transition-transform" id="breakfastIcon"></i>
                            </button>
                            <div id="breakfastSection" class="p-6 bg-white" style="display: none;">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-600 mb-2">Option A</label>
                                        <textarea
                                            id="breakfastA"
                                            class="meal-schedule-textarea w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                                            rows="4"
                                            placeholder="e.g., Chapati / Atta Rotti - 02 (medium size)&#10;Mixed vegetable preparation Sambar - 02-03 tbsp&#10;Lentil preparation - 2-3 tbsp&#10;Fish or chicken - 01 piece (30g)"
                                        ></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-600 mb-2">Option B</label>
                                        <textarea
                                            id="breakfastB"
                                            class="meal-schedule-textarea w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                                            rows="4"
                                            placeholder="e.g., Oats - 1/2 cup&#10;Milk - 1 cup (low-fat)&#10;Cinnamon - 1/2 tsp&#10;Chopped nuts - 1 tbsp"
                                        ></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-600 mb-2">Option C (Optional)</label>
                                        <textarea
                                            id="breakfastC"
                                            class="meal-schedule-textarea w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                                            rows="4"
                                            placeholder="Add third breakfast option if needed..."
                                        ></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Mid-Morning Snack -->
                        <div class="border-2 border-gray-300 rounded-lg overflow-hidden">
                            <button type="button" onclick="toggleSection('midMorningSection')" class="w-full px-6 py-4 bg-gradient-to-r from-green-50 to-emerald-50 hover:from-green-100 hover:to-emerald-100 text-left font-bold flex justify-between items-center transition" aria-expanded="false" aria-controls="midMorningSection">
                                <span class="meal-time-title text-lg">üçé Mid-Morning Snack (10:30 - 11:30 AM)</span>
                                <i class="fas fa-chevron-down transition-transform" id="midMorningIcon"></i>
                            </button>
                            <div id="midMorningSection" class="p-6 bg-white" style="display: none;">
                                <textarea
                                    id="midMorning"
                                    class="meal-schedule-textarea auto-grow w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                                    rows="2" maxlength="600"
                                    placeholder="e.g., Suitable fruit serving:&#10;Green Apple (1 medium), Strawberries (4-5), Orange (1 medium)&#10;OR Yogurt (sugar-free) + Vegetable salad"
                                ></textarea>
                            </div>
                        </div>

                        <!-- Lunch -->
                        <div class="border-2 border-gray-300 rounded-lg overflow-hidden">
                            <button type="button" onclick="toggleSection('lunchSection')" class="w-full px-6 py-4 bg-gradient-to-r from-blue-50 to-cyan-50 hover:from-blue-100 hover:to-cyan-100 text-left font-bold flex justify-between items-center transition" aria-expanded="false" aria-controls="lunchSection">
                                <span class="meal-time-title text-xl">üçΩÔ∏è Lunch (1:00 - 2:00 PM)</span>
                                <i class="fas fa-chevron-down transition-transform" id="lunchIcon"></i>
                            </button>
                            <div id="lunchSection" class="p-6 bg-white" style="display: none;">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-600 mb-2">Option A</label>
                                        <textarea
                                            id="lunchA"
                                            class="meal-schedule-textarea w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                                            rows="4"
                                            placeholder="e.g., Rice - 1 cup&#10;Lentil preparation - 2-3 tbsp&#10;Cooked vegetables - 2-3 tbsp&#10;Fish/Meat - 01 piece (30g) OR 01 egg"
                                        ></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-600 mb-2">Option B</label>
                                        <textarea
                                            id="lunchB"
                                            class="meal-schedule-textarea w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                                            rows="4"
                                            placeholder="e.g., Pasta/Noodles - 1 cup&#10;Egg - 01 or Chicken/Fish - 1 piece (30g)&#10;Boiled/Saut√© vegetables - 1 bowl"
                                        ></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Evening Snack -->
                        <div class="border-2 border-gray-300 rounded-lg overflow-hidden">
                            <button type="button" onclick="toggleSection('eveningSnackSection')" class="w-full px-6 py-4 bg-gradient-to-r from-orange-50 to-red-50 hover:from-orange-100 hover:to-red-100 text-left font-bold flex justify-between items-center transition" aria-expanded="false" aria-controls="eveningSnackSection">
                                <span class="meal-time-title text-lg">üç™ Evening Snack (4:00 - 5:00 PM)</span>
                                <i class="fas fa-chevron-down transition-transform" id="eveningSnackIcon"></i>
                            </button>
                            <div id="eveningSnackSection" class="p-6 bg-white" style="display: none;">
                                <textarea
                                    id="eveningSnack"
                                    class="meal-schedule-textarea auto-grow w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                                    rows="2" maxlength="600"
                                    placeholder="e.g., Ginger + lemon peel tea OR Cinnamon tea - 1 cup&#10;Nuts&#10;OR Fruit smoothie with yogurt + chia seeds"
                                ></textarea>
                            </div>
                        </div>

                        <!-- Before Dinner -->
                        <div class="border-2 border-gray-300 rounded-lg overflow-hidden">
                            <button type="button" onclick="toggleSection('beforeDinnerSection')" class="w-full px-6 py-4 bg-gradient-to-r from-teal-50 to-green-50 hover:from-teal-100 hover:to-green-100 text-left font-bold flex justify-between items-center transition" aria-expanded="false" aria-controls="beforeDinnerSection">
                                <span class="meal-time-title text-lg">ü•ó Before Dinner (7:00 - 8:00 PM)</span>
                                <i class="fas fa-chevron-down transition-transform" id="beforeDinnerIcon"></i>
                            </button>
                            <div id="beforeDinnerSection" class="p-6 bg-white" style="display: none;">
                                <textarea
                                    id="beforeDinner"
                                    class="meal-schedule-textarea w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                                    rows="2"
                                    placeholder="e.g., Vegetable salad OR Boiled/Saut√© vegetables OR Vegetable soup - 01 bowl"
                                ></textarea>
                            </div>
                        </div>

                        <!-- Dinner -->
                        <div class="border-2 border-gray-300 rounded-lg overflow-hidden">
                            <button type="button" onclick="toggleSection('dinnerSection')" class="w-full px-6 py-4 bg-gradient-to-r from-indigo-50 to-purple-50 hover:from-indigo-100 hover:to-purple-100 text-left font-bold flex justify-between items-center transition" aria-expanded="false" aria-controls="dinnerSection">
                                <span class="meal-time-title text-xl">üåô Dinner (8:30 - 9:30 PM)</span>
                                <i class="fas fa-chevron-down transition-transform" id="dinnerIcon"></i>
                            </button>
                            <div id="dinnerSection" class="p-6 bg-white" style="display: none;">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-600 mb-2">Option A</label>
                                        <textarea
                                            id="dinnerA"
                                            class="meal-schedule-textarea w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                                            rows="4"
                                            placeholder="e.g., Chapati - 02 (medium size)&#10;Mixed vegetable sambar - 2-3 tbsp&#10;Lentil preparation - 2-3 tbsp&#10;Fish or chicken - 01 piece (30g)"
                                        ></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-600 mb-2">Option B</label>
                                        <textarea
                                            id="dinnerB"
                                            class="meal-schedule-textarea w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                                            rows="4"
                                            placeholder="e.g., Mixed soup - 01 bowl&#10;(Vegetables + Chicken/Egg + Lentil + Vermicelli + Coconut oil)"
                                        ></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between mt-8">
                        <button
                            type="button"
                            onclick="goToStep(2)"
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-10 py-4 rounded-lg font-semibold flex items-center gap-2 transition"
                        >
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <button
                            type="button"
                            onclick="validateAndNext(3)"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-10 py-4 rounded-lg font-semibold flex items-center gap-2 transition shadow-lg hover:shadow-xl"
                        >
                            Next Step <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 4: Guidelines -->
            <div class="form-step" id="step4">
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                        <i class="fas fa-clipboard-check text-blue-600"></i>
                        Nutritional Guidelines & Recommendations
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                üíß Water Intake Recommendation
                            </label>
                            <input
                                type="text"
                                id="waterIntake"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                                value="2-3 liters per day"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                ü•• Virgin Coconut Oil
                            </label>
                            <input
                                type="text"
                                id="coconutOil"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                                value="03 tsp/day"
                            >
                        </div>
                    </div>

                    <div class="mb-8">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            üèÉ Exercise Recommendation
                        </label>
                        <textarea
                            id="exerciseRecommendation"
                            class="guidance-textarea w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                            rows="3"
                        >Weight Loss: Moderate intensity exercise - minimum 300 min/week
(Daily - 30 min to 01 hr. or 3-4 days/week - 1-1.5 hrs. e.g.: Cycling, Brisk walk, Jogging)</textarea>
                    </div>

                    <!-- Things to Consider - Checkboxes -->
                    <div class="mb-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">‚úÖ Things to Consider</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <label class="flex items-start p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition">
                                <input type="checkbox" class="checkbox-custom mr-3" id="guideline1" checked>
                                <span class="text-sm">Have your three main meals on time in small portions, do not skip any meals</span>
                            </label>
                            <label class="flex items-start p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition">
                                <input type="checkbox" class="checkbox-custom mr-3" id="guideline2" checked>
                                <span class="text-sm">Have less salt diet</span>
                            </label>
                            <label class="flex items-start p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition">
                                <input type="checkbox" class="checkbox-custom mr-3" id="guideline3" checked>
                                <span class="text-sm">Better to eat fruits rather than having fruit juices</span>
                            </label>
                            <label class="flex items-start p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition">
                                <input type="checkbox" class="checkbox-custom mr-3" id="guideline4" checked>
                                <span class="text-sm">Small fish like Herrings (Salaya), Hurulla, Salmon, Handella Sprats are preferable</span>
                            </label>
                            <label class="flex items-start p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition">
                                <input type="checkbox" class="checkbox-custom mr-3" id="guideline5" checked>
                                <span class="text-sm">Add garlic frequently to your food preparations</span>
                            </label>
                            <label class="flex items-start p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition">
                                <input type="checkbox" class="checkbox-custom mr-3" id="guideline6" checked>
                                <span class="text-sm">Be alert of your weight changes</span>
                            </label>
                            <label class="flex items-start p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition">
                                <input type="checkbox" class="checkbox-custom mr-3" id="guideline7" checked>
                                <span class="text-sm">Take 2-3 healthy snacks in addition to the 3 main meals</span>
                            </label>
                            <label class="flex items-start p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition">
                                <input type="checkbox" class="checkbox-custom mr-3" id="guideline8" checked>
                                <span class="text-sm">Avoid using oil during food preparation - select Baking, Grilling, Microwave</span>
                            </label>
                            <label class="flex items-start p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition">
                                <input type="checkbox" class="checkbox-custom mr-3" id="guideline9" checked>
                                <span class="text-sm">Regular exercise is important (for about 45 min) - Brisk Walk, Jogging, Swimming, Cycling</span>
                            </label>
                            <label class="flex items-start p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition">
                                <input type="checkbox" class="checkbox-custom mr-3" id="guideline10" checked>
                                <span class="text-sm">Stress Management is very important (Stress may affect Blood sugar level)</span>
                            </label>
                            <label class="flex items-start p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 transition">
                                <input type="checkbox" class="checkbox-custom mr-3" id="guideline11" checked>
                                <span class="text-sm">Get good sleep - Lack of sleep can increase insulin resistance</span>
                            </label>
                        </div>
                    </div>

                    <div class="mb-8">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            üö´ Foods to Strictly Avoid
                        </label>
                        <textarea
                            id="foodsToAvoid"
                            class="guidance-textarea w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                            rows="4"
                            placeholder="Enter specific foods to avoid (optional)&#10;e.g., Spicy food, Fried food, Processed snacks, Caffeine on empty stomach..."
                        ></textarea>
                    </div>

                    <div class="mb-8">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            üìù Special Instructions or Notes
                        </label>
                        <textarea
                            id="specialInstructions"
                            class="guidance-textarea w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                            rows="4"
                            placeholder="Any additional instructions, allergies, medical conditions, or special considerations..."
                        ></textarea>
                    </div>

                    <div class="flex justify-between mt-8">
                        <button
                            type="button"
                            onclick="goToStep(3)"
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-10 py-4 rounded-lg font-semibold flex items-center gap-2 transition"
                        >
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <button
                            type="button"
                            onclick="validateAndNext(4)"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-10 py-4 rounded-lg font-semibold flex items-center gap-2 transition shadow-lg hover:shadow-xl"
                        >
                            Next Step <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 5: Generate PDF -->
            <div class="form-step" id="step5">
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                        <i class="fas fa-file-pdf text-blue-600"></i>
                        Professional Details & PDF Generation
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Nutritionist Name
                            </label>
                            <input
                                type="text"
                                id="nutritionistName"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-gray-50"
                                value="Gayathri Dissanayaka"
                                readonly
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Credentials
                            </label>
                            <input
                                type="text"
                                id="credentials"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-gray-50"
                                value="Dietitian & Nutritionist"
                                readonly
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Contact Phone
                            </label>
                            <input
                                type="tel"
                                id="nutritionistPhone"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                                placeholder="+94 XX XXX XXXX"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Contact Email
                            </label>
                            <input
                                type="email"
                                id="nutritionistEmail"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                                placeholder="contact@email.com"
                            >
                        </div>
                    </div>

                    <div class="mb-8">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Practice Address
                        </label>
                        <textarea
                            id="nutritionistAddress"
                            class="address-textarea w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none transition"
                            rows="2"
                            placeholder="Enter clinic/practice address"
                        ></textarea>
                    </div>

                    <!-- NEW FEATURE: Font Size Customization for Elderly -->
                    <div class="mb-8 p-6 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl border-2 border-purple-200">
                        <h3 class="text-xl font-bold text-purple-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-text-height"></i>
                            PDF Font Size Customization
                        </h3>
                        <p class="text-gray-700 mb-4">Adjust font sizes for better readability, especially for elderly patients</p>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Patient Type
                                </label>
                                <select
                                    id="pdfFontSizePreset"
                                    class="w-full px-4 py-3 border-2 border-purple-300 rounded-lg focus:border-purple-600 focus:outline-none transition"
                                    onchange="applyFontSizePreset()"
                                >
                                    <option value="standard">Standard (All Ages)</option>
                                    <option value="elderly">Elderly Friendly (Large Text)</option>
                                    <option value="custom">Custom Sizes</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Heading Font Size
                                </label>
                                <div class="flex items-center gap-3">
                                    <input
                                        type="range"
                                        id="headingFontSize"
                                        min="11"
                                        max="18"
                                        value="14"
                                        class="flex-1"
                                        oninput="updateFontSizeDisplay()"
                                    >
                                    <span id="headingSizeDisplay" class="font-bold text-purple-700 w-12">14pt</span>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Content Font Size
                                </label>
                                <div class="flex items-center gap-3">
                                    <input
                                        type="range"
                                        id="contentFontSize"
                                        min="8"
                                        max="14"
                                        value="10"
                                        class="flex-1"
                                        oninput="updateFontSizeDisplay()"
                                    >
                                    <span id="contentSizeDisplay" class="font-bold text-purple-700 w-12">10pt</span>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 p-4 bg-white rounded-lg border border-purple-200">
                            <p class="text-sm text-gray-600">
                                <strong>Preview:</strong> Headings will be <span id="headingPreview" class="font-bold">14pt</span>,
                                meal content will be <span id="contentPreview" class="font-bold">10pt</span>
                            </p>
                        </div>
                    </div>

                    <!-- Ready to Generate -->
                    <div class="bg-gradient-to-r from-blue-50 to-cyan-50 border-2 border-blue-200 rounded-xl p-8 mb-8">
                        <h3 class="text-2xl font-bold text-blue-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-check-circle text-green-600"></i>
                            Ready to Generate PDF
                        </h3>
                        <p class="text-gray-700 mb-6 text-lg">
                            Your personalized meal plan is complete and ready to download as a professional PDF document.
                        </p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="flex items-center gap-3 p-3 bg-white rounded-lg">
                                <i class="fas fa-check text-green-600 text-xl"></i>
                                <span class="font-semibold">Patient information completed</span>
                            </div>
                            <div class="flex items-center gap-3 p-3 bg-white rounded-lg">
                                <i class="fas fa-check text-green-600 text-xl"></i>
                                <span class="font-semibold">Physical measurements recorded</span>
                            </div>
                            <div class="flex items-center gap-3 p-3 bg-white rounded-lg">
                                <i class="fas fa-check text-green-600 text-xl"></i>
                                <span class="font-semibold">Meal plan configured</span>
                            </div>
                            <div class="flex items-center gap-3 p-3 bg-white rounded-lg">
                                <i class="fas fa-check text-green-600 text-xl"></i>
                                <span class="font-semibold">Guidelines added</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white border-2 border-blue-200 rounded-xl p-5 mb-6 shadow-sm">
                        <label for="includeMealTable" class="flex items-start gap-3 cursor-pointer">
                            <input
                                type="checkbox"
                                id="includeMealTable"
                                class="checkbox-custom"
                            >
                            <span>
                                <span class="block text-base font-semibold text-gray-800">Include meal plan as a table in PDF (optional)</span>
                                <span class="block text-sm text-gray-600">Turn this on to include MEAL PLAN TABLE in the PDF. Leave it unchecked to include DAILY MEAL SCHEDULE instead. Only one section will be included.</span>
                            </span>
                        </label>
                    </div>

                    <div class="flex justify-between mt-8 flex-wrap gap-4">
                        <button
                            type="button"
                            onclick="goToStep(4)"
                            class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-10 py-4 rounded-lg font-semibold flex items-center gap-2 transition"
                        >
                            <i class="fas fa-arrow-left"></i> Previous
                        </button>
                        <div class="flex gap-4 flex-wrap">
                            <button
                                type="button"
                                onclick="exportTemplate()"
                                class="bg-purple-600 hover:bg-purple-700 text-white px-8 py-4 rounded-lg font-semibold flex items-center gap-2 transition shadow-lg hover:shadow-xl"
                            >
                                <i class="fas fa-download"></i> Export Template
                            </button>
                            <button
                                type="button"
                                onclick="importTemplate()"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-4 rounded-lg font-semibold flex items-center gap-2 transition shadow-lg hover:shadow-xl"
                            >
                                <i class="fas fa-upload"></i> Import Template
                            </button>
                            <button
                                type="button"
                                onclick="generatePDF()"
                                id="generatePdfBtn"
                                class="bg-green-600 hover:bg-green-700 text-white px-10 py-4 rounded-lg font-semibold flex items-center gap-2 transition shadow-xl hover:shadow-2xl text-lg"
                            >
                                <i class="fas fa-file-pdf"></i> Generate PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <aside class="hidden xl:block xl:col-span-4">
            <div class="bg-white rounded-xl shadow-lg p-6 sticky top-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Current Summary</h3>
                <div id="summaryPanel" class="space-y-2 text-sm text-gray-700">
                    <p><strong>Name:</strong> <span data-summary="patientName">‚Äî</span></p>
                    <p><strong>Age/Gender:</strong> <span data-summary="ageGender">‚Äî</span></p>
                    <p><strong>Date:</strong> <span data-summary="planDate">‚Äî</span></p>
                    <p><strong>BMI:</strong> <span data-summary="bmi">‚Äî</span></p>
                    <p><strong>Calories:</strong> <span data-summary="calories">‚Äî</span></p>
                    <p><strong>Plan:</strong> <span data-summary="planType">General</span></p>
                </div>
            </div>
        </aside>
        </div>

        <!-- Quick Actions Floating Panel -->
        <div class="bg-white rounded-xl shadow-2xl p-6 mt-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-bolt text-yellow-500"></i>
                Quick Actions
            </h3>
            <div class="flex flex-wrap gap-3">
                <button
                    type="button"
                    onclick="saveData()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2 transition shadow-lg"
                >
                    <i class="fas fa-save"></i> Save Progress
                </button>
                <button
                    type="button"
                    onclick="loadSavedData()"
                    class="bg-cyan-600 hover:bg-cyan-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2 transition shadow-lg"
                >
                    <i class="fas fa-folder-open"></i> Load Saved Data
                </button>
                <button
                    type="button"
                    onclick="clearForm()"
                    class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2 transition shadow-lg"
                >
                    <i class="fas fa-trash-alt"></i> Clear Form
                </button>
                <button
                    type="button"
                    onclick="printPreview()"
                    class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2 transition shadow-lg"
                >
                    <i class="fas fa-print"></i> Print Preview
                </button>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gradient-to-r from-gray-800 to-gray-900 text-white mt-16 py-8">
        <div class="container mx-auto px-4">
            <div class="text-center">
                <p class="text-lg font-semibold">&copy; 2026 Gayathri Dissanayaka - Dietitian & Nutritionist</p>
                <p class="text-gray-400 mt-2">Professional Meal Plan Generator - All Features Edition v1.0</p>
                <p class="text-sm text-gray-500 mt-3">
                    Powered by Modern Web Technologies | Made with ‚ù§Ô∏è for Better Nutrition
                </p>
            </div>
        </div>
    </footer>

    <!-- Hidden File Input for Template Import -->
    <input type="file" id="templateImportInput" accept=".json" style="display: none;" onchange="handleTemplateImport(event)">

    <script>
        // Set today's date
        document.getElementById('planDate').valueAsDate = new Date();

        // Current step
        let currentStep = 1;
        let autoSaveTimer;
        let canShowDraftToast = false;

        function showStepSummary() {
            const set = (key, value) => {
                const el = document.querySelector(`[data-summary="${key}"]`);
                if (el) el.textContent = value || '‚Äî';
            };
            const name = document.getElementById('patientName')?.value?.trim();
            const age = document.getElementById('patientAge')?.value;
            const gender = document.getElementById('patientGender')?.value;
            set('patientName', name || '‚Äî');
            set('ageGender', age ? `${age}${gender ? ` / ${gender}` : ''}` : '‚Äî');
            set('planDate', document.getElementById('planDate')?.value || '‚Äî');
            set('bmi', document.getElementById('bmiValue')?.textContent === '--' ? '‚Äî' : document.getElementById('bmiValue')?.textContent);
            set('calories', document.getElementById('calorieTarget')?.value ? `${document.getElementById('calorieTarget').value} kcal` : '‚Äî');
            set('planType', document.querySelector('input[name="planType"]:checked')?.value || 'general');
        }

        function openInitialMealSection() {
            const breakfastSection = document.getElementById('breakfastSection');
            if (breakfastSection && breakfastSection.style.display !== 'block') {
                toggleSection('breakfastSection');
            }
        }

        // Navigate to step
        function goToStep(stepNumber, clicked = false) {
            if (clicked && stepNumber > currentStep) return;
            document.querySelectorAll('.form-step').forEach(step => step.classList.remove('active'));
            document.getElementById('step' + stepNumber).classList.add('active');
            updateProgressIndicators(stepNumber);
            currentStep = stepNumber;
            showStepSummary();
            if (stepNumber === 3) openInitialMealSection();
            const activeCard = document.querySelector(`#step${stepNumber} .bg-white`);
            if (activeCard) activeCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Update progress indicators
        function updateProgressIndicators(activeStep) {
            for (let i = 1; i <= 5; i++) {
                const icon = document.getElementById('step' + i + '-icon');
                const label = document.getElementById('step' + i + '-label');
                if (icon && label) {
                    if (i <= activeStep) {
                        icon.classList.remove('bg-gray-300');
                        icon.classList.add('bg-blue-600');
                        label.classList.remove('text-gray-500');
                        label.classList.add('text-blue-600', 'font-semibold');
                    } else {
                        icon.classList.remove('bg-blue-600');
                        icon.classList.add('bg-gray-300');
                        label.classList.remove('text-blue-600', 'font-semibold');
                        label.classList.add('text-gray-500');
                    }
                }
            }
            const progress = Math.round((activeStep / 5) * 100);
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            const mobileStepText = document.getElementById('mobileStepText');
            if (progressBar) progressBar.style.width = `${progress}%`;
            if (progressPercent) progressPercent.textContent = `${progress}%`;
            if (mobileStepText) mobileStepText.textContent = `Step ${activeStep} of 5`;
        }

        // Validation and next
        function validateAndNext(step) {
            let isValid = true;

            if (step === 1) {
                // Validate patient info
                const name = document.getElementById('patientName');
                const age = document.getElementById('patientAge');
                const gender = document.getElementById('patientGender');
                const email = document.getElementById('patientEmail');
                const phone = document.getElementById('patientPhone');

                if (!name.value.trim()) {
                    showValidationError(name, 'nameError');
                    isValid = false;
                }

                if (!age.value || age.value < 1 || age.value > 120) {
                    showValidationError(age, 'ageError');
                    isValid = false;
                }

                if (!gender.value) {
                    showValidationError(gender, 'genderError');
                    isValid = false;
                }

                // Email validation (if provided)
                if (email.value && !isValidEmail(email.value)) {
                    showValidationError(email, 'emailError');
                    isValid = false;
                }

                // Phone validation (if provided)
                if (phone.value && !isValidPhone(phone.value)) {
                    showValidationError(phone, 'phoneError');
                    isValid = false;
                }
            }

            if (step === 2) {
                // Validate measurements
                const height = document.getElementById('patientHeight');
                const weight = document.getElementById('patientWeight');
                const target = document.getElementById('targetWeight');

                if (!height.value || height.value < 100 || height.value > 250) {
                    showValidationError(height, null);
                    isValid = false;
                }

                if (!weight.value || weight.value < 30 || weight.value > 300) {
                    showValidationError(weight, null);
                    isValid = false;
                }

                if (!target.value || target.value < 30 || target.value > 300) {
                    showValidationError(target, null);
                    isValid = false;
                }
            }

            if (step === 3) {
                const calorieTarget = document.getElementById('calorieTarget');
                const planDuration = document.getElementById('planDuration');
                const hasMealContent = [
                    'earlyMorning', 'breakfastA', 'breakfastB', 'breakfastC',
                    'midMorning', 'lunchA', 'lunchB', 'eveningSnack', 'beforeDinner', 'dinnerA', 'dinnerB'
                ].some((id) => document.getElementById(id).value.trim().length > 0);

                if (!calorieTarget.value || calorieTarget.value < 1000 || calorieTarget.value > 5000) {
                    showValidationError(calorieTarget, null);
                    isValid = false;
                }

                if (!planDuration.value || planDuration.value < 1 || planDuration.value > 30) {
                    showValidationError(planDuration, null);
                    isValid = false;
                }

                if (!hasMealContent) {
                    isValid = false;
                    Swal.fire({
                        icon: 'warning',
                        title: 'Add at least one meal entry',
                        text: 'Please provide content for at least one meal section before continuing.',
                        confirmButtonColor: '#1877F2'
                    });
                }
            }

            if (step === 4) {
                const waterIntake = document.getElementById('waterIntake');
                const exerciseRecommendation = document.getElementById('exerciseRecommendation');

                if (!waterIntake.value.trim()) {
                    showValidationError(waterIntake, null);
                    isValid = false;
                }

                if (!exerciseRecommendation.value.trim()) {
                    showValidationError(exerciseRecommendation, null);
                    isValid = false;
                }
            }

            if (isValid) {
                goToStep(step + 1);
            } else {
                Swal.fire({
                    icon: 'warning',
                    title: 'Validation Error',
                    text: 'Please fill in all required fields correctly',
                    confirmButtonColor: '#1877F2'
                });
            }
        }

        // Show validation error
        function showValidationError(input, errorId) {
            input.classList.add('error-border');
            if (errorId) {
                const errorElement = document.getElementById(errorId);
                if (errorElement) {
                    errorElement.innerHTML = `<i class="fas fa-exclamation-circle mr-1" aria-hidden="true"></i>${errorElement.textContent.replace(/^‚ö†Ô∏è\s*/, '')}`;
                    errorElement.classList.remove('hidden');
                }
            }
        }

        function markFieldValid(input) {
            input.classList.remove('error-border');
            input.classList.add('border-green-500');
            const indicator = input.parentElement.querySelector('.field-success-indicator');
            if (indicator) indicator.classList.remove('hidden');
        }

        // Email validation
        function isValidEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        // Phone validation
        function isValidPhone(phone) {
            return /^[\+]?[0-9]{10,15}$/.test(phone.replace(/\s/g, ''));
        }

        // Toggle section
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const icon = document.getElementById(sectionId.replace('Section', 'Icon'));
            const triggerButton = document.querySelector(`button[aria-controls="${sectionId}"]`);

            if (section.style.display === 'none' || section.style.display === '') {
                section.style.display = 'block';
                if (icon) icon.style.transform = 'rotate(180deg)';
                if (triggerButton) triggerButton.setAttribute('aria-expanded', 'true');
            } else {
                section.style.display = 'none';
                if (icon) icon.style.transform = 'rotate(0deg)';
                if (triggerButton) triggerButton.setAttribute('aria-expanded', 'false');
            }
        }

        function showDraftSavedToast() {
            if (!canShowDraftToast) return;
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 left-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm';
            toast.textContent = 'Draft saved ‚úì';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 1800);
        }

        function autoSaveDraft() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                const formData = collectFormData();
                localStorage.setItem('mealPlanDraft', JSON.stringify(formData));
                showStepSummary();
                showDraftSavedToast();
            }, 400);
        }

        // Calculate BMI
        function calculateBMI() {
            const height = parseFloat(document.getElementById('patientHeight').value);
            const weight = parseFloat(document.getElementById('patientWeight').value);
            const gender = document.getElementById('patientGender').value;
            const targetWeightInput = parseFloat(document.getElementById('targetWeight').value);
            const targetWeight = Number.isFinite(targetWeightInput) ? targetWeightInput : null;

            if (height && weight && height > 0 && weight > 0) {
                const heightInMeters = height / 100;
                const bmi = (weight / (heightInMeters * heightInMeters)).toFixed(1);

                // Calculate IBW
                let ibw = 0;
                const heightInInches = height / 2.54;
                if (gender === 'Male') {
                    ibw = 50 + 2.3 * (heightInInches - 60);
                } else if (gender === 'Female') {
                    ibw = 45.5 + 2.3 * (heightInInches - 60);
                }
                ibw = Math.max(30, Math.round(ibw * 10) / 10);

                // Get category
                let category = '';
                let badgeClass = '';
                if (bmi < 18.5) {
                    category = 'Underweight';
                    badgeClass = 'bg-blue-100 text-blue-800';
                } else if (bmi >= 18.5 && bmi < 25) {
                    category = 'Normal Weight';
                    badgeClass = 'bg-green-100 text-green-800';
                } else if (bmi >= 25 && bmi < 30) {
                    category = 'Overweight';
                    badgeClass = 'bg-orange-100 text-orange-800';
                } else {
                    category = 'Obese';
                    badgeClass = 'bg-red-100 text-red-800';
                }

                // Target weight change
                const weightGoalLabel = document.getElementById('weightGoalLabel');
                const weightDiff = targetWeight !== null ? (weight - targetWeight) : null;
                const absDiff = weightDiff !== null ? Math.abs(weightDiff) : 0;
                const weeksToGoal = absDiff > 0 ? Math.ceil(absDiff / 0.5) : 0; // 0.5 kg per week
                const monthsToGoal = weeksToGoal > 0 ? Math.ceil(weeksToGoal / 4) : 0;

                // Display
                document.getElementById('bmiValue').textContent = bmi;
                document.getElementById('ibwValue').textContent = ibw;

                if (targetWeight === null) {
                    document.getElementById('weightToLose').textContent = '--';
                    document.getElementById('timelineEstimate').textContent = 'Enter target weight';
                    if (weightGoalLabel) weightGoalLabel.textContent = 'Target Weight Change';
                } else if (weightDiff > 0) {
                    document.getElementById('weightToLose').textContent = absDiff.toFixed(1) + ' kg';
                    document.getElementById('timelineEstimate').textContent = `Approx. ${monthsToGoal} month${monthsToGoal > 1 ? 's' : ''} to lose`;
                    if (weightGoalLabel) weightGoalLabel.textContent = 'Weight to Lose';
                } else if (weightDiff < 0) {
                    document.getElementById('weightToLose').textContent = absDiff.toFixed(1) + ' kg';
                    document.getElementById('timelineEstimate').textContent = `Approx. ${monthsToGoal} month${monthsToGoal > 1 ? 's' : ''} to gain`;
                    if (weightGoalLabel) weightGoalLabel.textContent = 'Weight to Gain';
                } else {
                    document.getElementById('weightToLose').textContent = '0.0 kg';
                    document.getElementById('timelineEstimate').textContent = 'At target!';
                    if (weightGoalLabel) weightGoalLabel.textContent = 'Target Weight Change';
                }

                document.getElementById('bmiCategoryBadge').textContent = category;
                document.getElementById('bmiCategoryBadge').className = `px-4 py-1 rounded-full text-sm font-semibold ${badgeClass}`;
                document.getElementById('bmiDisplay').style.display = 'block';

                // Auto-suggest calories (rough estimate)
                const bmr = gender === 'Male' ?
                    (10 * weight) + (6.25 * height) - (5 * (document.getElementById('patientAge').value || 30)) + 5 :
                    (10 * weight) + (6.25 * height) - (5 * (document.getElementById('patientAge').value || 30)) - 161;

                const calorieTarget = Math.round(bmr * 1.375); // Light activity
                document.getElementById('calorieTarget').value = calorieTarget;
            }
        }

        function getMealPlatePercentages() {
            const vegetables = parseInt(document.getElementById('plateVegetables').value, 10) || 0;
            const protein = parseInt(document.getElementById('plateProtein').value, 10) || 0;
            const grains = parseInt(document.getElementById('plateGrains').value, 10) || 0;
            return { vegetables, protein, grains, total: vegetables + protein + grains };
        }

        function updateMealPlateChart() {
            const canvas = document.getElementById('mealPlateCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const { vegetables, protein, grains, total } = getMealPlatePercentages();
            const totalLabel = document.getElementById('plateTotal');
            const errorLabel = document.getElementById('plateTotalError');

            if (totalLabel) {
                totalLabel.textContent = `${total}%`;
                totalLabel.className = `font-bold ${total === 100 ? 'text-green-700' : 'text-red-700'}`;
            }
            if (errorLabel) {
                errorLabel.classList.toggle('hidden', total === 100);
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(canvas.width, canvas.height) * 0.44;
            const holeRadius = radius * 0.5;
            const colors = ['#93B56B', '#6AB4E4', '#F3C55B'];
            const values = [vegetables, protein, grains];

            let start = -Math.PI / 2;
            values.forEach((value, i) => {
                const angle = total > 0 ? (value / total) * Math.PI * 2 : 0;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, start, start + angle);
                ctx.closePath();
                ctx.fillStyle = colors[i];
                ctx.fill();

                if (value > 0) {
                    const labelAngle = start + angle / 2;
                    const labelX = centerX + Math.cos(labelAngle) * (radius * 0.72);
                    const labelY = centerY + Math.sin(labelAngle) * (radius * 0.72);
                    ctx.fillStyle = '#0F172A';
                    ctx.font = 'bold 12px Inter, Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(`${value}%`, labelX, labelY);
                }

                start += angle;
            });

            ctx.beginPath();
            ctx.arc(centerX, centerY, holeRadius, 0, Math.PI * 2);
            ctx.fillStyle = '#FFFFFF';
            ctx.fill();

            ctx.fillStyle = '#1F2937';
            ctx.font = 'bold 13px Inter, Arial';
            ctx.textAlign = 'center';
            ctx.fillText('MEAL', centerX, centerY - 5);
            ctx.fillText('PLATE', centerX, centerY + 13);
        }

        // Font size customization
        function applyFontSizePreset() {
            const preset = document.getElementById('pdfFontSizePreset').value;

            if (preset === 'standard') {
                document.getElementById('headingFontSize').value = 14;
                document.getElementById('contentFontSize').value = 10;
            } else if (preset === 'elderly') {
                document.getElementById('headingFontSize').value = 16;
                document.getElementById('contentFontSize').value = 13;
            }

            updateFontSizeDisplay();
        }

        function updateFontSizeDisplay() {
            const heading = document.getElementById('headingFontSize').value;
            const content = document.getElementById('contentFontSize').value;

            document.getElementById('headingSizeDisplay').textContent = heading + 'pt';
            document.getElementById('contentSizeDisplay').textContent = content + 'pt';
            document.getElementById('headingPreview').textContent = heading + 'pt';
            document.getElementById('contentPreview').textContent = content + 'pt';
        }

        // Save data
        function saveData() {
            const formData = collectFormData();
            localStorage.setItem('mealPlanData', JSON.stringify(formData));

            Swal.fire({
                icon: 'success',
                title: 'Progress Saved!',
                text: 'Your meal plan data has been saved locally',
                timer: 2000,
                showConfirmButton: false
            });
        }

        // Collect all form data
        function collectFormData() {
            return {
                patient: {
                    name: document.getElementById('patientName').value,
                    age: document.getElementById('patientAge').value,
                    gender: document.getElementById('patientGender').value,
                    date: document.getElementById('planDate').value,
                    nextFollowupDate: document.getElementById('nextFollowupDate').value,
                    phone: document.getElementById('patientPhone').value,
                    email: document.getElementById('patientEmail').value,
                    address: document.getElementById('patientAddress').value
                },
                measurements: {
                    height: document.getElementById('patientHeight').value,
                    weight: document.getElementById('patientWeight').value,
                    targetWeight: document.getElementById('targetWeight').value,
                    bmi: document.getElementById('bmiValue').textContent
                },
                mealPlan: {
                    planType: document.querySelector('input[name="planType"]:checked').value,
                    calorieTarget: document.getElementById('calorieTarget').value,
                    planDuration: document.getElementById('planDuration').value,
                    preferences: {
                        vegetarian: document.getElementById('prefVegetarian').checked,
                        nonVeg: document.getElementById('prefNonVeg').checked,
                        lowCarb: document.getElementById('prefLowCarb').checked,
                        highProtein: document.getElementById('prefHighProtein').checked
                    },
                    meals: {
                        earlyMorning: document.getElementById('earlyMorning').value,
                        breakfastA: document.getElementById('breakfastA').value,
                        breakfastB: document.getElementById('breakfastB').value,
                        breakfastC: document.getElementById('breakfastC').value,
                        midMorning: document.getElementById('midMorning').value,
                        lunchA: document.getElementById('lunchA').value,
                        lunchB: document.getElementById('lunchB').value,
                        eveningSnack: document.getElementById('eveningSnack').value,
                        beforeDinner: document.getElementById('beforeDinner').value,
                        dinnerA: document.getElementById('dinnerA').value,
                        dinnerB: document.getElementById('dinnerB').value
                    },
                    mealPlate: {
                        vegetables: document.getElementById('plateVegetables').value,
                        protein: document.getElementById('plateProtein').value,
                        grains: document.getElementById('plateGrains').value
                    }
                },
                guidelines: {
                    waterIntake: document.getElementById('waterIntake').value,
                    coconutOil: document.getElementById('coconutOil').value,
                    exercise: document.getElementById('exerciseRecommendation').value,
                    foodsToAvoid: document.getElementById('foodsToAvoid').value,
                    specialInstructions: document.getElementById('specialInstructions').value,
                    checkboxes: Array.from({length: 11}, (_, i) =>
                        document.getElementById('guideline' + (i+1))?.checked || false
                    )
                },
                nutritionist: {
                    name: document.getElementById('nutritionistName').value,
                    credentials: document.getElementById('credentials').value,
                    phone: document.getElementById('nutritionistPhone').value,
                    email: document.getElementById('nutritionistEmail').value,
                    address: document.getElementById('nutritionistAddress').value
                },
                pdfSettings: {
                    fontSizePreset: document.getElementById('pdfFontSizePreset').value,
                    headingFontSize: document.getElementById('headingFontSize').value,
                    contentFontSize: document.getElementById('contentFontSize').value,
                    includeMealTable: document.getElementById('includeMealTable')?.checked || false
                }
            };
        }

        // Load saved data
        function loadSavedData() {
            const savedData = localStorage.getItem('mealPlanData');
            if (savedData) {
                const data = JSON.parse(savedData);

                // Load patient data
                document.getElementById('patientName').value = data.patient?.name || '';
                document.getElementById('patientAge').value = data.patient?.age || '';
                document.getElementById('patientGender').value = data.patient?.gender || '';
                document.getElementById('planDate').value = data.patient?.date || '';
                document.getElementById('nextFollowupDate').value = data.patient?.nextFollowupDate || '';
                document.getElementById('patientPhone').value = data.patient?.phone || '';
                document.getElementById('patientEmail').value = data.patient?.email || '';
                document.getElementById('patientAddress').value = data.patient?.address || '';

                // Load measurements
                document.getElementById('patientHeight').value = data.measurements?.height || '';
                document.getElementById('patientWeight').value = data.measurements?.weight || '';
                document.getElementById('targetWeight').value = data.measurements?.targetWeight || '';

                // Load meal plan
                if (data.mealPlan) {
                    document.getElementById('calorieTarget').value = data.mealPlan.calorieTarget || '';
                    document.getElementById('planDuration').value = data.mealPlan.planDuration || '';

                    // Load preferences
                    if (data.mealPlan.preferences) {
                        document.getElementById('prefVegetarian').checked = data.mealPlan.preferences.vegetarian;
                        document.getElementById('prefNonVeg').checked = data.mealPlan.preferences.nonVeg;
                        document.getElementById('prefLowCarb').checked = data.mealPlan.preferences.lowCarb;
                        document.getElementById('prefHighProtein').checked = data.mealPlan.preferences.highProtein;
                    }

                    // Load meals
                    if (data.mealPlan.meals) {
                        document.getElementById('earlyMorning').value = data.mealPlan.meals.earlyMorning || '';
                        document.getElementById('breakfastA').value = data.mealPlan.meals.breakfastA || '';
                        document.getElementById('breakfastB').value = data.mealPlan.meals.breakfastB || '';
                        document.getElementById('breakfastC').value = data.mealPlan.meals.breakfastC || '';
                        document.getElementById('midMorning').value = data.mealPlan.meals.midMorning || '';
                        document.getElementById('lunchA').value = data.mealPlan.meals.lunchA || '';
                        document.getElementById('lunchB').value = data.mealPlan.meals.lunchB || '';
                        document.getElementById('eveningSnack').value = data.mealPlan.meals.eveningSnack || '';
                        document.getElementById('beforeDinner').value = data.mealPlan.meals.beforeDinner || '';
                        document.getElementById('dinnerA').value = data.mealPlan.meals.dinnerA || '';
                        document.getElementById('dinnerB').value = data.mealPlan.meals.dinnerB || '';
                    }

                    if (data.mealPlan.mealPlate) {
                        document.getElementById('plateVegetables').value = data.mealPlan.mealPlate.vegetables ?? 50;
                        document.getElementById('plateProtein').value = data.mealPlan.mealPlate.protein ?? 25;
                        document.getElementById('plateGrains').value = data.mealPlan.mealPlate.grains ?? 25;
                    }
                }

                // Load guidelines
                if (data.guidelines) {
                    document.getElementById('waterIntake').value = data.guidelines.waterIntake || '';
                    document.getElementById('coconutOil').value = data.guidelines.coconutOil || '';
                    document.getElementById('exerciseRecommendation').value = data.guidelines.exercise || '';
                    document.getElementById('foodsToAvoid').value = data.guidelines.foodsToAvoid || '';
                    document.getElementById('specialInstructions').value = data.guidelines.specialInstructions || '';

                    // Load checkboxes
                    if (data.guidelines.checkboxes) {
                        data.guidelines.checkboxes.forEach((checked, i) => {
                            const checkbox = document.getElementById('guideline' + (i+1));
                            if (checkbox) checkbox.checked = checked;
                        });
                    }
                }

                // Load nutritionist data
                if (data.nutritionist) {
                    document.getElementById('nutritionistPhone').value = data.nutritionist.phone || '';
                    document.getElementById('nutritionistEmail').value = data.nutritionist.email || '';
                    document.getElementById('nutritionistAddress').value = data.nutritionist.address || '';
                }

                // Load PDF settings
                if (data.pdfSettings) {
                    document.getElementById('pdfFontSizePreset').value = data.pdfSettings.fontSizePreset || 'standard';
                    document.getElementById('headingFontSize').value = data.pdfSettings.headingFontSize || 14;
                    document.getElementById('contentFontSize').value = data.pdfSettings.contentFontSize || 10;
                    document.getElementById('includeMealTable').checked = data.pdfSettings.includeMealTable || false;
                    updateFontSizeDisplay();
                }

                calculateBMI();
                updateMealPlateChart();

                Swal.fire({
                    icon: 'success',
                    title: 'Data Loaded!',
                    text: 'Saved data has been restored',
                    timer: 2000,
                    showConfirmButton: false
                });
            } else {
                Swal.fire({
                    icon: 'info',
                    title: 'No Saved Data',
                    text: 'No previously saved data found'
                });
            }
        }

        // Clear form
        function clearForm() {
            Swal.fire({
                icon: 'warning',
                title: 'Clear Form?',
                text: 'This will clear all form data. This action cannot be undone.',
                showCancelButton: true,
                confirmButtonColor: '#EF4444',
                confirmButtonText: 'Yes, clear it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('mealPlanForm').reset();
                    document.getElementById('planDate').valueAsDate = new Date();
                    document.getElementById('bmiDisplay').style.display = 'none';
                    localStorage.removeItem('mealPlanData');
                    localStorage.removeItem('mealPlanDraft');
                    document.getElementById('templateImportInput').value = '';
                    goToStep(1);

                    Swal.fire({
                        icon: 'success',
                        title: 'Cleared!',
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
            });
        }

        // Export template
        function exportTemplate() {
            const formData = collectFormData();
            const dataStr = JSON.stringify(formData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `MealPlan_Template_${new Date().toISOString().split('T')[0]}.json`;
            link.click();

            Swal.fire({
                icon: 'success',
                title: 'Template Exported!',
                text: 'Template has been downloaded as JSON file',
                timer: 2000,
                showConfirmButton: false
            });
        }

        // Import template
        function importTemplate() {
            document.getElementById('templateImportInput').click();
        }

        // Handle template import
        function handleTemplateImport(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        localStorage.setItem('mealPlanData', JSON.stringify(data));
                        loadSavedData();

                        Swal.fire({
                            icon: 'success',
                            title: 'Template Imported!',
                            text: 'Template has been loaded successfully'
                        });
                    } catch (error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Import Failed',
                            text: 'Invalid template file format'
                        });
                    }
                };
                reader.readAsText(file);
            }
        }

        // Print preview
        function printPreview() {
            window.print();
        }

        function initRealtimeValidation() {
            const requiredFields = ['patientName', 'patientAge', 'patientGender', 'patientHeight', 'patientWeight', 'targetWeight', 'calorieTarget', 'planDuration', 'waterIntake', 'exerciseRecommendation'];
            requiredFields.forEach((id) => {
                const field = document.getElementById(id);
                if (!field) return;
                const success = document.createElement('span');
                success.className = 'field-success-indicator hidden text-green-600 text-xs mt-1 block';
                success.innerHTML = '<i class="fas fa-check-circle mr-1"></i>Looks good';
                field.parentElement.appendChild(success);
                field.addEventListener('blur', () => {
                    const valid = field.value && String(field.value).trim().length > 0;
                    if (valid) {
                        markFieldValid(field);
                    }
                });
            });
        }

        function initTextareaEnhancements() {
            document.querySelectorAll('textarea').forEach((textarea) => {
                if (!textarea.classList.contains('auto-grow')) textarea.classList.add('auto-grow');
                const counter = document.createElement('div');
                counter.className = 'text-xs text-gray-500 mt-1 text-right';
                const updateCounter = () => {
                    const minimumHeight = 136;
                    const preferredHeight = Math.max(textarea.scrollHeight, minimumHeight, textarea.clientHeight);
                    textarea.style.height = `${preferredHeight}px`;
                    counter.textContent = `${textarea.value.length} chars`;
                };
                textarea.insertAdjacentElement('afterend', counter);
                textarea.addEventListener('input', updateCounter);
                updateCounter();
            });
        }

        // Generate PDF - COMPREHENSIVE VERSION WITH FONT SIZE CUSTOMIZATION
        async function generatePDF() {
            if (!window.jspdf || !window.jspdf.jsPDF) {
                Swal.fire({
                    icon: 'error',
                    title: 'PDF library not available',
                    text: 'Please check your internet connection and reload the page to generate PDFs.'
                });
                return;
            }

            const generateBtn = document.getElementById('generatePdfBtn');
            if (generateBtn) {
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            }

            Swal.fire({
                title: 'Generating PDF...',
                html: 'Creating your personalized meal plan document',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ unit: 'mm', format: 'a4' });

                const headingSize = parseInt(document.getElementById('headingFontSize').value, 10);
                const contentSize = parseInt(document.getElementById('contentFontSize').value, 10);
                const titleSize = headingSize + 4;
                const subheadingSize = Math.max(headingSize - 1, 10);

                const formData = collectFormData();
                const includeMealTable = document.getElementById('includeMealTable')?.checked || false;
                const now = new Date();

                const sanitizeForPdf = (value = '') => String(value ?? '').replace(/[^\x20-\x7E\n\r\t]/g, '').trim();
                const sanitizeMultiline = (value = '') => String(value ?? '')
                    .replace(/[^\x20-\x7E\n\r\t]/g, '')
                    .split('\n')
                    .map((line) => line.trim())
                    .filter(Boolean)
                    .join('\n');
                const ensureSafe = (value, fallback = 'Not provided') => sanitizeForPdf(value) || fallback;
                const renderDate = (value) => {
                    const d = new Date(value);
                    return Number.isNaN(d.getTime()) ? ensureSafe(value) : d.toLocaleDateString();
                };

                const drawHeader = () => {
                    doc.setFillColor(24, 119, 242);
                    doc.rect(0, 0, 210, 38, 'F');

                    doc.setFillColor(255, 255, 255);
                    doc.circle(18, 18, 7.5, 'F');
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10);
                    doc.setTextColor(24, 119, 242);
                    doc.text('MP', 18, 20, { align: 'center' });

                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(titleSize);
                    doc.text(ensureSafe(formData.nutritionist.name, 'Meal Plan Generator'), 32, 15);

                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(subheadingSize);
                    doc.text(ensureSafe(formData.nutritionist.credentials, 'Dietitian & Nutritionist'), 32, 23);

                    const contact = [sanitizeForPdf(formData.nutritionist.phone), sanitizeForPdf(formData.nutritionist.email)]
                        .filter(Boolean)
                        .join(' | ');
                    if (contact) {
                        doc.setFontSize(Math.max(contentSize - 1, 9));
                        doc.text(contact, 32, 30);
                    }
                };

                const ensureSpace = (yPos, needed = 20) => {
                    if (yPos + needed > 276) {
                        doc.addPage();
                        drawHeader();
                        return 48;
                    }
                    return yPos;
                };

                const renderTextBlock = (title, content, yPos, opts = {}) => {
                    if (!content) return yPos;
                    const headingColor = opts.headingColor || [24, 119, 242];
                    const contentColor = opts.contentColor || [17, 24, 39];

                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(headingSize);
                    doc.setTextColor(...headingColor);
                    doc.text(title, 15, yPos);
                    yPos += 6;

                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(contentSize);
                    doc.setTextColor(...contentColor);
                    const lines = doc.splitTextToSize(content, 175);
                    doc.text(lines, 18, yPos);
                    return yPos + (lines.length * (contentSize * 0.42)) + 6;
                };

                const addFooter = () => {
                    const pageCount = doc.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        doc.setPage(i);
                        doc.setDrawColor(220, 224, 230);
                        doc.line(12, 283, 198, 283);
                        doc.setFontSize(Math.max(contentSize - 2, 8));
                        doc.setTextColor(100, 110, 125);
                        doc.text(`Generated on: ${now.toLocaleDateString()}`, 15, 288);
                        doc.text(`Page ${i} of ${pageCount}`, 195, 288, { align: 'right' });
                        doc.text(`¬© ${ensureSafe(formData.nutritionist.name, 'Meal Plan Generator')}`, 105, 292, { align: 'center' });
                    }
                };

                drawHeader();
                let yPos = 48;

                doc.setTextColor(24, 119, 242);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(titleSize + 1);
                doc.text('PERSONALIZED MEAL PLAN', 105, yPos, { align: 'center' });
                yPos += 8;

                doc.setFillColor(244, 248, 255);
                doc.setDrawColor(210, 221, 238);
                doc.roundedRect(15, yPos, 180, 40, 3, 3, 'FD');
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(15, 23, 42);
                doc.setFontSize(headingSize);
                doc.text(`Patient: ${ensureSafe(formData.patient.name)}`, 20, yPos + 8);
                doc.text(`Date: ${renderDate(formData.patient.date)}`, 140, yPos + 8);

                doc.setFont('helvetica', 'normal');
                doc.setFontSize(contentSize);
                doc.text(`Age: ${ensureSafe(formData.patient.age)} years`, 20, yPos + 16);
                doc.text(`Gender: ${ensureSafe(formData.patient.gender)}`, 80, yPos + 16);
                doc.text(`Height: ${ensureSafe(formData.measurements.height)} cm`, 20, yPos + 23);
                doc.text(`Weight: ${ensureSafe(formData.measurements.weight)} kg`, 80, yPos + 23);
                doc.text(`Target: ${ensureSafe(formData.measurements.targetWeight)} kg`, 140, yPos + 23);
                doc.text(`BMI: ${ensureSafe(formData.measurements.bmi)} kg/m2`, 20, yPos + 30);
                doc.text(`Calories: ${ensureSafe(formData.mealPlan.calorieTarget, 'Not set')} kcal/day`, 80, yPos + 30);
                doc.text(`Next Follow-up: ${renderDate(formData.patient.nextFollowupDate)}`, 20, yPos + 37);
                yPos += 48;

                const prefs = [];
                if (formData.mealPlan.preferences?.vegetarian) prefs.push('Vegetarian');
                if (formData.mealPlan.preferences?.nonVeg) prefs.push('Non-Vegetarian');
                if (formData.mealPlan.preferences?.lowCarb) prefs.push('Low Carb');
                if (formData.mealPlan.preferences?.highProtein) prefs.push('High Protein');
                if (prefs.length) {
                    doc.setFont('helvetica', 'italic');
                    doc.setFontSize(Math.max(contentSize - 1, 9));
                    doc.setTextColor(71, 85, 105);
                    doc.text(`Dietary preferences: ${prefs.join(', ')}`, 15, yPos);
                    yPos += 7;
                }

                const plateCanvas = document.getElementById('mealPlateCanvas');
                if (plateCanvas) {
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const desiredPlateWidth = pageWidth * 0.8;
                    const plateImage = plateCanvas.toDataURL('image/png');
                    const plate = formData.mealPlan.mealPlate || {};
                    doc.setTextColor(24, 119, 242);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(subheadingSize);
                    doc.text('CUSTOM MEAL PLATE RATIO', 105, yPos, { align: 'center' });
                    yPos += 6;

                    const plateLegendSpace = 12;
                    const maxAvailableHeight = Math.max(60, 272 - yPos - plateLegendSpace);
                    const plateSize = Math.min(desiredPlateWidth, maxAvailableHeight);
                    const plateX = (pageWidth - plateSize) / 2;

                    yPos = ensureSpace(yPos, plateSize + plateLegendSpace + 2);

                    doc.addImage(plateImage, 'PNG', plateX, yPos, plateSize, plateSize);
                    yPos += plateSize + 6;
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(Math.max(contentSize - 1, 9));
                    doc.text(`Vegetables/Fruits: ${plate.vegetables || 0}%`, 62, yPos, { align: 'center' });
                    doc.text(`Protein: ${plate.protein || 0}%`, 105, yPos, { align: 'center' });
                    doc.text(`Carbohydrates: ${plate.grains || 0}%`, 148, yPos, { align: 'center' });
                }

                doc.addPage();
                drawHeader();
                yPos = 48;

                if (!includeMealTable) {
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(titleSize);
                    doc.setTextColor(24, 119, 242);
                    doc.text('DAILY MEAL SCHEDULE', 15, yPos);
                    yPos += 10;

                    const mealBlocks = [
                        ['Early Morning (7:00 AM)', sanitizeMultiline(formData.mealPlan.meals.earlyMorning)],
                        ['Breakfast (8:30-9:30 AM)', [
                            formData.mealPlan.meals.breakfastA ? `Option A: ${sanitizeMultiline(formData.mealPlan.meals.breakfastA)}` : '',
                            formData.mealPlan.meals.breakfastB ? `Option B: ${sanitizeMultiline(formData.mealPlan.meals.breakfastB)}` : '',
                            formData.mealPlan.meals.breakfastC ? `Option C: ${sanitizeMultiline(formData.mealPlan.meals.breakfastC)}` : ''
                        ].filter(Boolean).join('\n\n')],
                        ['Mid-Morning Snack (10:30-11:30 AM)', sanitizeMultiline(formData.mealPlan.meals.midMorning)],
                        ['Lunch (1:00-2:00 PM)', [
                            formData.mealPlan.meals.lunchA ? `Option A: ${sanitizeMultiline(formData.mealPlan.meals.lunchA)}` : '',
                            formData.mealPlan.meals.lunchB ? `Option B: ${sanitizeMultiline(formData.mealPlan.meals.lunchB)}` : ''
                        ].filter(Boolean).join('\n\n')],
                        ['Evening Snack (4:00-5:00 PM)', sanitizeMultiline(formData.mealPlan.meals.eveningSnack)],
                        ['Before Dinner (7:00-8:00 PM)', sanitizeMultiline(formData.mealPlan.meals.beforeDinner)],
                        ['Dinner (8:30-9:30 PM)', [
                            formData.mealPlan.meals.dinnerA ? `Option A: ${sanitizeMultiline(formData.mealPlan.meals.dinnerA)}` : '',
                            formData.mealPlan.meals.dinnerB ? `Option B: ${sanitizeMultiline(formData.mealPlan.meals.dinnerB)}` : ''
                        ].filter(Boolean).join('\n\n')]
                    ];

                    mealBlocks.forEach(([title, content]) => {
                        if (!content) return;
                        yPos = ensureSpace(yPos, 22);
                        yPos = renderTextBlock(title, content, yPos, { headingColor: [30, 64, 175] });
                    });
                } else {
                    doc.setTextColor(24, 119, 242);
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(titleSize);
                    doc.text('MEAL PLAN TABLE', 15, 48);

                    const formatMealOptions = (...options) => options
                        .map((opt) => sanitizeMultiline(opt || '').trim())
                        .filter(Boolean)
                        .join('\n\n');

                    const mealTableRows = [
                        ['Early Morning (7:00 AM)', sanitizeMultiline(formData.mealPlan.meals.earlyMorning || '-')],
                        ['Breakfast (8:30-9:30 AM)', formatMealOptions(
                            formData.mealPlan.meals.breakfastA && `Option A:\n${formData.mealPlan.meals.breakfastA}`,
                            formData.mealPlan.meals.breakfastB && `Option B:\n${formData.mealPlan.meals.breakfastB}`,
                            formData.mealPlan.meals.breakfastC && `Option C:\n${formData.mealPlan.meals.breakfastC}`
                        ) || '-'],
                        ['Mid-Morning Snack (10:30-11:30 AM)', sanitizeMultiline(formData.mealPlan.meals.midMorning || '-')],
                        ['Lunch (1:00-2:00 PM)', formatMealOptions(
                            formData.mealPlan.meals.lunchA && `Option A:\n${formData.mealPlan.meals.lunchA}`,
                            formData.mealPlan.meals.lunchB && `Option B:\n${formData.mealPlan.meals.lunchB}`
                        ) || '-'],
                        ['Evening Snack (4:00-5:00 PM)', sanitizeMultiline(formData.mealPlan.meals.eveningSnack || '-')],
                        ['Before Dinner (7:00-8:00 PM)', sanitizeMultiline(formData.mealPlan.meals.beforeDinner || '-')],
                        ['Dinner (8:30-9:30 PM)', formatMealOptions(
                            formData.mealPlan.meals.dinnerA && `Option A:\n${formData.mealPlan.meals.dinnerA}`,
                            formData.mealPlan.meals.dinnerB && `Option B:\n${formData.mealPlan.meals.dinnerB}`
                        ) || '-']
                    ];

                    doc.autoTable({
                        startY: 56,
                        head: [['Meal Time', 'Plan Details']],
                        body: mealTableRows,
                        theme: 'grid',
                        headStyles: { fillColor: [24, 119, 242], textColor: 255, fontStyle: 'bold' },
                        alternateRowStyles: { fillColor: [248, 250, 252] },
                        styles: {
                            font: 'helvetica',
                            fontSize: Math.max(8, contentSize - 1),
                            cellPadding: 2.4,
                            overflow: 'linebreak',
                            valign: 'top'
                        },
                        columnStyles: {
                            0: { cellWidth: 52, fontStyle: 'bold' },
                            1: { cellWidth: 128 }
                        },
                        margin: { left: 15, right: 15 }
                    });
                }

                doc.addPage();
                drawHeader();
                yPos = 48;

                doc.setFontSize(titleSize);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(24, 119, 242);
                doc.text('NUTRITIONAL GUIDELINES & RECOMMENDATIONS', 15, yPos);
                yPos += 12;

                const hydration = `Water Intake: ${ensureSafe(formData.guidelines.waterIntake)}
Coconut Oil Guidance: ${ensureSafe(formData.guidelines.coconutOil)}`;
                yPos = renderTextBlock('Daily Targets', hydration, yPos, { headingColor: [2, 132, 199] });
                yPos = ensureSpace(yPos, 28);
                yPos = renderTextBlock('Exercise Recommendation', sanitizeMultiline(formData.guidelines.exercise), yPos, { headingColor: [5, 150, 105] });

                const guidelineTexts = [
                    'Have your three main meals on time in small portions, do not skip any meals',
                    'Have less salt diet',
                    'Better to eat fruits rather than having fruit juices',
                    'Small fish like Herrings (Salaya), Hurulla, Salmon, Handella Sprats are preferable',
                    'Add garlic frequently to your food preparations',
                    'Be alert of your weight changes',
                    'Take 2-3 healthy snacks in addition to the 3 main meals',
                    'Avoid using oil during food preparation - select Baking, Grilling, Microwave',
                    'Regular exercise is important (for about 45 min)',
                    'Stress management is very important',
                    'Get good sleep - lack of sleep can increase insulin resistance'
                ];

                const selectedGuidelines = guidelineTexts
                    .filter((_, i) => formData.guidelines.checkboxes?.[i])
                    .map((line, idx) => `${idx + 1}. ${line}`)
                    .join('\n');

                yPos = ensureSpace(yPos, 36);
                yPos = renderTextBlock('Things to Consider', selectedGuidelines || 'No additional checklist items selected.', yPos, { headingColor: [124, 58, 237] });

                if (formData.guidelines.foodsToAvoid) {
                    yPos = ensureSpace(yPos, 26);
                    yPos = renderTextBlock('Foods to Avoid', sanitizeMultiline(formData.guidelines.foodsToAvoid), yPos, {
                        headingColor: [220, 38, 38],
                        contentColor: [127, 29, 29]
                    });
                }

                if (formData.guidelines.specialInstructions) {
                    yPos = ensureSpace(yPos, 26);
                    renderTextBlock('Special Instructions', sanitizeMultiline(formData.guidelines.specialInstructions), yPos, {
                        headingColor: [37, 99, 235]
                    });
                }

                addFooter();

                const safeName = ensureSafe(formData.patient.name, 'Patient').replace(/\s+/g, '_');
                const safeDate = ensureSafe(formData.patient.date, now.toISOString().split('T')[0]);
                doc.save(`MealPlan_${safeName}_${safeDate}.pdf`);

                Swal.fire({
                    icon: 'success',
                    title: 'PDF Generated Successfully!',
                    text: 'Your personalized meal plan has been downloaded.',
                    confirmButtonColor: '#42B72A',
                    confirmButtonText: 'Great!'
                });
            } catch (error) {
                console.error('PDF Generation Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'PDF Generation Failed',
                    text: 'An error occurred while generating the PDF. Please try again.',
                    footer: error.message
                });
            } finally {
                if (generateBtn) {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Generate PDF';
                }
            }
        }

        // Initialize
        updateFontSizeDisplay();
        updateProgressIndicators(currentStep);
        initRealtimeValidation();
        initTextareaEnhancements();
        showStepSummary();
        setTimeout(() => { canShowDraftToast = true; }, 1200);
        document.querySelectorAll('#mealPlanForm input, #mealPlanForm textarea, #mealPlanForm select').forEach((field) => {
            field.addEventListener('input', autoSaveDraft);
            field.addEventListener('change', autoSaveDraft);
        });

        const savedDraft = localStorage.getItem('mealPlanDraft');
        if (savedDraft && !localStorage.getItem('mealPlanData')) {
            localStorage.setItem('mealPlanData', savedDraft);
            loadSavedData();
        }
    </script>
</body>
</html>
